function showOrhideTestDriveButtonEstimate(s) {
    var a = $("#hdIdlr").val(),
        e = $("#hdApiUrl").val(),
        t = toyotaDealerLog();
    $.ajax({
        type: "Get",
        url: e + "/api/Tools/LoadListCatsCompare?idDlr=" + a,
        headers: {
            Authorization: "X-XSRF-Token " + t,
            "X-XSRF-Token": t,
            "Content-Type": "application/json"
        },
        success: function(a) {
            for (var e = 0, t = 0; t < a.length; t++) s == a[t].id && e++;
            0 === e ? ($("#btnTestDrive").addClass("hide"), $("#btnSupportFinance >*").removeClass("bg-light-grey")) : ($("#btnTestDrive").removeClass("hide"), $("#btnSupportFinance >*").addClass("bg-light-grey"))
        }
    })
}

function changeDataBeforeComplete() {
    var a = $("#hdApiUrl").val(),
        e = toyotaDealerLog(),
        t = $("#hdIdlr").val(),
        s = $(".checkCarTool:checked"),
        c = $("#hdCurrentCarId_Area").val(),
        o = $("#hdCurrentCarId_Access").val(),
        l = $("#hdEstimated_Prepare").val();
    if (c != l && ($("#ddlAreaSelect").val($("#hdDefaultEstimate").val()), $("#ddlAreaSelect").material_select("destroy"), $("#ddlAreaSelect").material_select(), changeAreaValue(), $("#hdCurrentCarId_Area").val(l)), $("#hdCurrentCarId_Access").val(l), o != l) {
        $("#hdSumofAccessory").val(0);
        $(".listAccessSelected").each(function() {
            $(this).empty(), $('<p class="txt_tt">Phụ kiện</p>').appendTo(this)
        }), $("#ulAccessoriesTool").empty(), $("#tabsContentAccessories").empty();
        var n = "/api/Detail/GetAccessoriesNewCar?CatId=" + $(s).data("catid") + "&idDlr=" + t;
        $.ajax({
            type: "Get",
            url: a + n,
            headers: {
                Authorization: "X-XSRF-Token " + e,
                "X-XSRF-Token": e,
                "Content-Type": "application/json"
            },
            success: function(a) {
                if (0 < a.length) {
                    for (var e = "", t = "", s = $("#hdMoneyUnit").val(), c = 0; c < a.length; c++) {
                        t += '<li class="tab"><a href="#tab_accessories_tool_0' + (c + 1) + '">' + a[c].name + "</a></li>", e += '<div id="tab_accessories_tool_0' + (c + 1) + '" class="content-tab"><div class="inner list-cate all list-accessories"><ul class="">';
                        for (var o = 0; o < a[c].lAcces.length; o++) {
                            var l = formatMoney(a[c].lAcces[o].aS_PRICE + ".000");
                            e += '<li class="item"><div class="inner"><div class="sm_checkbox"><input data-image="/data/accessories/' + a[c].lAcces[o].id + "/" + a[c].lAcces[o].aS_IMG + '"class="chkAccessoriesCar" data-name="' + a[c].lAcces[o].aS_TITLE + '" data-price="' + l + '"type="checkbox" id="checkbox-accs-0' + a[c].lAcces[o].id + '"><label for="checkbox-accs-0' + a[c].lAcces[o].id + '"><span class="img"><img src="/data/accessories/' + a[c].lAcces[o].id + "/" + a[c].lAcces[o].aS_IMG + '?w=257&h=127&mode=crop" alt=""></span><span class="txt"><span class="txt1"><span class="check"></span></span><span class="txt2"><span class="name">' + a[c].lAcces[o].aS_TITLE + '</span><span class="price"><span>' + l + "</span><sup>" + s + "</sup></span></span></span></label>  </div></div></li>"
                        }
                        e += "</ul></div></div></div>"
                    }
                    $(t).appendTo("#ulAccessoriesTool"), $(e).appendTo("#tabsContentAccessories"), $("#hdSumofAccessory").val(0), $("img.lazy").lazyload({
                        effect: "fadeIn",
                        threshold: 200
                    }), $(".dutoan_tabs ul.tabs").tabs(), $(".chkAccessoriesCar").on("click", function() {
                        $(".listAccessSelected").empty();
                        var a = '<p class="txt_tt">Phụ kiện</p>',
                            e = "<table style='height: 21px;' width='393'>",
                            t = 0;
                        $(".chkAccessoriesCar:checked").each(function() {
                            e += "<tr><td>" + $(this).data("name") + '</td><td style="text-align: right;">' + $(this).data("price") + "</td></tr>", a += '<p class="row"> <span class="col s7"> ' + $(this).data("name") + '</span> <span class="col s5 right-align">' + $(this).data("price") + " </span> </p>", t += parseFloat($(this).data("price").replace(/\./g, ""))
                        }), $("#hdSumofAccessory").val(t), $(".listAccessSelected").each(function() {
                            $(a).appendTo(this)
                        }), e += "</table>", $("#hddlistAccessSelected").val(e), calcSumMoney()
                    })
                } else $("#tabsContentAccessories").html("<p>Chưa có phụ kiện!</p>");
                $(".list-accessories").each(function() {})
            }
        }), $("#hdCurrentCarId_Access").val(l)
    }
    $(".nameOfCarSelectedTool").text($(s).data("name")), $(".priceOfCarSelectedTool").text(0 == $("#ddlMausac").val() ? "Sẽ cập nhật sau" : FormatNumber($("#ddlMausac").val())), $(".areaOfCarSelectedTool").text($("#ddlAreaSelect").find("option:selected").text()), $("#hdIsChangeDataBeforeCompeteEstimated").val(!0)
}

function changeAreaValue() {
    var a = toyotaDealerLog(),
        C = $(".checkCarTool:checked"),
        e = $("#hdApiUrl").val(),
        t = "/api/Estimates/LoadEstimates?NewId=" + $(C).data("idcar") + "&idArea=" + $("#ddlAreaSelect").val(),
        m = "Sẽ cập nhật sau";
    $.ajax({
        type: "Get",
        url: e + t,
        headers: {
            Authorization: "X-XSRF-Token " + a,
            "X-XSRF-Token": a,
            "Content-Type": "application/json"
        },
        success: function(a) {
            $("#listEstimate").empty();
            for (var e = parseFloat($(C).data("price").replace(/\./g, "")), t = 0, s = 0, c = "", o = "<table style='height: 21px;' width='393'>", l = 0, n = 0; n < a.length; n++) {
                var d = a[n];
                if (2 === d.action) {
                    c += '<p class="row"> <span class="col s12">' + d.name + "</span></p>", o += "<tr><td>" + d.name + '</td><td style="text-align: right;"></td></tr>';
                    var i = d.cosT_PERCENT.split("-");
                    l = i.length;
                    for (var r = "", p = "", h = 0; h < i.length; h++) {
                        var u = parseFloat(i[h]) * e / 100;
                        0 < h ? s += u : t += u, r += h < i.length - 1 ? formatMoney(u + ".000") + " - " : formatMoney(u + ".000"), p += h < i.length - 1 ? i[h] + " - " : i[h]
                    }
                    c += '<p class="row"><span class="col s5">&nbsp;&nbsp;&nbsp;Mức phí</span><span class="col s7 right-align">' + p + "%</span></p>", o += '<tr><td>  Mức phí</td><td style="text-align: right;">' + p + "%</td></tr>", c += '<p class="row"><span class="col s2">&nbsp;&nbsp;&nbsp;Phí</span><span class="col s10 right-align">' + (0 == e ? m : r) + "</span></p>", o += '<tr><td>   Phí</td><td style="text-align: right;">' + (0 == e ? m : r) + "</td></tr>"
                } else o += "<tr><td>" + d.name + '</td> <td style="text-align: right;">' + formatMoney(d.cost + ".000") + "</td></tr>", c += '<p class="row"> <span class="col s7">' + d.name + '</span> <span class="col s5 right-align">' + formatMoney(d.cost + ".000") + "</span> </p>", t += d.cost, s += d.cost
            }
            o += "</table>", $(c).appendTo("#listEstimate"), $("#hddlistEstimate").val(o), $("#hdCurrentEstimate_Price").val(t), $("#hdCurrentEstimate_Price2").val(1 < l ? s : 0), calcSumMoney()
        }
    }), $(".areaOfCarSelectedTool").text($("#ddlAreaSelect").find("option:selected").text())
}

function changeArea() {
    $(".dutoan_tabs .tab").find("a").removeClass("active"), $(".dutoan_tabs .content-tab").css("display", "none"), $("#tab_dutoan_03").css("display", "block"), $("a[href*='#tab_dutoan_03']").addClass("active"), changeDataBeforeComplete()
}

function changeAccessories() {
    $(".dutoan_tabs .tab").find("a").removeClass("active"), $(".dutoan_tabs .content-tab").css("display", "none"), $("#tab_dutoan_02").css("display", "block"), $("a[href*='#tab_dutoan_02']").addClass("active"), changeDataBeforeComplete(), "" != $("#ulAccessoriesTool").html() && ($("#ulAccessoriesTool a[href*='#tab_accessories_tool_01']").addClass("active"), $("#tab_accessories_tool_01").css("display", "block"), $("#ulAccessoriesTool .tab").on("click", function() {
        $("#ulAccessoriesTool .tab").not(this).find("a").removeClass("active"), $("#tabsContentAccessories .content-tab").css("display", "none"), $($(this).find("a").attr("href")).css("display", "block")
    }))
}

function selectCarFirst() {
    return 0 !== $(".checkCarTool:checked").length || (showErrorbyAlert("Dự toán chi phí", "<p>Vui lòng chọn trước 1 phiên bản xe!<p>", ""), $(".dutoan_tabs ul.tabs").tabs("select_tab", "tab_dutoan_01"), $(".selectAccesoriesEstimate").addClass("disabled"), $(".selectAreaEstimate").addClass("disabled"), $(".complete").addClass("disabled"), !1)
}

function calcSumMoney() {
    var a = $("#ddlMausac").val();
    null == a && (a = "0");
    var e = parseFloat(a.replace(/\./g, "")),
        t = "Sẽ cập nhật sau";
    $(".colorOfCarSelectedTool").text($("#ddlMausac option:selected").text());
    var s = 0;
    $(".chkAccessoriesCar:checked").each(function() {
        s += parseFloat($(this).data("price").replace(/\./g, ""))
    });
    var c = parseFloat($("#hdCurrentEstimate_Price").val().replace(/\./g, "")),
        o = parseFloat($("#hdCurrentEstimate_Price2").val().replace(/\./g, ""));
    0 == e ? ($(".priceOfCarSelectedTool_Sum2").parent().find("sup").addClass("hide"), $(".priceOfCarSelectedTool_Sum1").parent().find("sup").addClass("hide")) : ($(".priceOfCarSelectedTool_Sum2").parent().find("sup").removeClass("hide"), $(".priceOfCarSelectedTool_Sum1").parent().find("sup").removeClass("hide")), $(".priceOfCarSelectedTool_Sum1, .priceOfCarSelectedTool_Sum2").text(0 == e ? t : formatMoney(e + s + c + ".000")), 0 < o && $(".priceOfCarSelectedTool_Sum2").text((0 == e ? t : formatMoney(e + s + c + ".000")) + " - " + (0 == e ? t : formatMoney(e + s + o + ".000")))
}

function checkCarToolEstimate() {
    $(".checkCarTool").on("click", function() {
        $(".checkCarTool:checked").not(this).prop("checked", ""), $(this).prop("checked", !0), $("#hdEstimated_Prepare").val($(this).data("idcar")), 0 < $(".checkCarTool:checked").length ? ($(".selectAccesoriesEstimate").removeClass("disabled"), $(".selectAreaEstimate").removeClass("disabled"), $(".complete").removeClass("disabled")) : ($(".selectAccesoriesEstimate").addClass("disabled"), $(".selectAreaEstimate").addClass("disabled"), $(".complete").addClass("disabled")), LoadColor($(this).data("idcar")), $(".selectAreaEstimate").click()
    })
}

function LoadColor(s) {
    var a = $("#hdApiUrl").val(),
        e = $("#hd__ToyotaDealerProject").val();
    $.ajax({
        url: a + "/api/Detail/GetColorProductById?idNew=" + s,
        type: "GET",
        headers: {
            Authorization: "X-XSRF-Token " + e,
            "X-XSRF-Token": e,
            "Content-Type": "application/json"
        },
        success: function(a) {
            $("#ddlMausac").html("");
            var t = "";
            $.each(a, function(a, e) {
                0 == a && ($(".priceOfCarSelectedTool").text(0 == e.neW_CL_PRICE ? "Sẽ cập nhật sau" : FormatNumber(e.neW_CL_PRICE)), $(".imageOfCarSelectedTool").attr("src", "/data/news/" + s + "/_color/" + e.neW_CL_IMG + "?width=500")), t += '<option data-img="/data/news/' + s + "/_color/" + e.neW_CL_IMG + '?width=500" value="' + e.neW_CL_PRICE + '" data-id="' + e.id + '">' + e.neW_CL_TITLE + "</option>"
            }), $("#ddlMausac").html(t), $("#ddlMausac").material_select(), calcSumMoney()
        }
    })
}
$(document).ready(function() {
    if ($(".dutoan_tabs .next_btn_0").on("click", function() {
            $(".dutoan_tabs .tab").find("a").removeClass("active"), $(".dutoan_tabs .content-tab").css("display", "none"), $("#tab_dutoan_01").css("display", "block"), $("a[href*='#tab_dutoan_01']").addClass("active")
        }), $(".dutoan_tabs .next_btn_3").on("click", function() {
            $(".dutoan_tabs .dutoan_tabs .tab").find("a").removeClass("active"), $(".dutoan_tabs .content-tab").css("display", "none"), $("#tab_dutoan_04").css("display", "block"), $("a[href*='#tab_dutoan_03']").addClass("active")
        }), checkCarToolEstimate(), $(".various").fancybox({}), $(".selectAccesoriesEstimate").on("click", function() {
            selectCarFirst() && changeAccessories()
        }), $("#ddlAreaSelect").on("change", function() {
            changeAreaValue()
        }), $(".selectAreaEstimate").on("click", function() {
            selectCarFirst() && changeArea()
        }), $(".complete").on("click", function() {
            if (selectCarFirst()) {
                $(".dutoan_tabs .tab").find("a").removeClass("active"), $(".dutoan_tabs .content-tab").css("display", "none"), $("#tab_dutoan_04").css("display", "block"), $("a[href*='#tab_dutoan_04']").addClass("active");
                var a = $(".checkCarTool:checked");
                showOrhideTestDriveButtonEstimate($(a).data("catid")), 1 != $("#hdIsChangeDataBeforeCompeteEstimated").val() && (changeDataBeforeComplete(), $(".btnSendEmail").parent().removeClass("disabled-button")), checkCanGetAPost("ciEstimateCountperDay") && postUserClickTools($(a).data("idcar"), "DUTOANCHIPHI")
            }
        }), $(".areaOfCarSelectedTool").text($(this).find("option:selected").text()), 0 < $(".checkCarTool:checked").length) {
        var a = $(".checkCarTool:checked");
        $("#hdEstimated_Prepare").val($(a).data("idcar")), $(".selectAreaEstimate").click(), $(".dutoan_tabs .tab").find("a").removeClass("active"), $(".dutoan_tabs .content-tab").css("display", "none"), $("#tab_dutoan_03").css("display", "block"), $("a[href*='#tab_dutoan_03']").addClass("active"), $(".dutoan_tabs li.tab").addClass("disabled"), LoadColor($(a).data("idcar"))
    }
    $(".btnGotoSupport").on("click", function() {
        var a = $(this).data("link"),
            e = $(".checkCarTool:checked"),
            t = $(e).data("url"),
            s = $("#hdSumofAccessory").val(),
            c = $("#ddlMausac option:selected").data("id");
        window.location.href = a + "?car=" + t + "&price=" + s + "&color=" + c
    }), $(".btnGotoTestDrive").on("click", function() {
        var a = $(this).data("link"),
            e = $(".checkCarTool:checked"),
            t = $(e).data("caturl");
        window.location.href = a + "?cat=" + t
    }), $(".checkCarTool").on("change", function() {
        var a = $("#hdEstimated_Prepare").val();
        $("#hdEstimated_Complete").val() == a ? $("#hdIsChangeDataBeforeCompeteEstimated").val(!0) : $("#hdIsChangeDataBeforeCompeteEstimated").val(!1)
    }), checkCarToolEstimate(), $("#ddlMausac").on("change", function() {
        var a = $(this).val();
        $(".priceOfCarSelectedTool").text(0 == a ? "Sẽ cập nhật sau" : FormatNumber(a)), $(".colorOfCarSelectedTool").text($("#ddlMausac option:selected").text());
        var e = $("#ddlMausac option:selected").data("img");
        $(".imageOfCarSelectedTool").attr("src", e), calcSumMoney()
    })
});
