function CalcFirstMoneyBefore() {
    var price = ($(".checkCarTool:checked"), $("#ddlMausac").val());
    null == price && (price = "0");
    var priceOfCar = parseFloat(RemoveAllPoint(price));
    $(".colorOfCarSelectedTool").text($("#ddlMausac option:selected").text());
    var accessoryPrice = parseFloat(RemoveAllPoint("" == $("#txtAccessoryPrice").val() || "0" == $("#txtAccessoryPrice").val() ? "0" : $("#txtAccessoryPrice").val())),
        supportProduct = $("#ddlSupporProduct").val();
    if (1 == supportProduct) {
        var perHaftPrice = Math.floor((priceOfCar + accessoryPrice) / 2);
        $("#txtFirstMoney").attr("placeholder", "Tối thiểu " + formatMoney(perHaftPrice + ".000"))
    } else {
        var percentPrice = Math.floor(10 * (priceOfCar + accessoryPrice) / 100);
        $("#txtFirstMoney").attr("placeholder", "Tối thiểu " + formatMoney(percentPrice + ".000"))
    }
    var finalSeptem = Math.floor(.3 * (priceOfCar + accessoryPrice));
    $("#txtFinalSeptem").attr("placeholder", "Tối đa " + formatMoney(finalSeptem + ".000"))
}

function checkCarToolSupportFinance() {
    $(".checkCarTool").on("click", function() {
        $(".checkCarTool:checked").not(this).prop("checked", ""), $(this).prop("checked", !0), $(".checkCarTool:checked").length > 0 ? ($(".selectSupport").removeClass("disabled"), $(".complete").removeClass("disabled")) : ($(".selectSupport").addClass("disabled"), $(".complete").addClass("disabled")), $(".spResultTitle").text($(this).data("name")), $(".spResultPrice").text($(this).data("price"));
        var idNew = $(this).data("idcar");
        LoadColor(idNew), $(".selectSupport").click()
    })
}

function LoadColor(idNew) {
    var api = $("#hdApiUrl").val(),
        awesomeToyota = $("#hd__ToyotaDealerProject").val();
    $.ajax({
        url: api + "/api/Detail/GetColorProductById?idNew=" + idNew,
        type: "GET",
        headers: {
            Authorization: "X-XSRF-Token " + awesomeToyota,
            "X-XSRF-Token": awesomeToyota,
            "Content-Type": "application/json"
        },
        success: function(data) {
            var colorid = parseInt($("#hdColorId").val());
            $("#ddlMausac").html("");
            var str = "";
            $.each(data, function(i, item) {
                if (colorid > 0) {
                    var selected = "";
                    colorid == item.id && (selected = "selected", $(".spResultPrice").text(FormatNumber(item.neW_CL_PRICE)), $(".spResultImage").attr("src", "/data/news/" + idNew + "/_color/" + item.neW_CL_IMG + "?width=500"))
                } else 0 == i && ($(".spResultPrice").text(FormatNumber(item.neW_CL_PRICE)), $(".spResultImage").attr("src", "/data/news/" + idNew + "/_color/" + item.neW_CL_IMG + "?width=500"));
                str += "<option " + selected + ' data-img="/data/news/' + idNew + "/_color/" + item.neW_CL_IMG + '?width=500" value="' + item.neW_CL_PRICE + '" data-id="' + item.id + '">' + item.neW_CL_TITLE + "</option>"
            }), $("#ddlMausac").html(str), $("#ddlMausac").material_select(), CalcFirstMoneyBefore()
        }
    })
}

function selectCarFirst() {
    return 0 === $(".checkCarTool:checked").length ? (showErrorbyAlert("Hỗ trợ tài chính", "<p>Vui lòng chọn trước 1 phiên bản xe!<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_01").css("display", "block"), $("a[href*='#tab_hotrotaichinh_01']").addClass("active"), $(".selectSupport").addClass("disabled"), $(".complete").addClass("disabled"), !1) : !0
}

function checkInput() {
    var selectCar = $(".checkCarTool:checked"),
        priceOfCar = parseFloat(RemoveAllPoint($(selectCar).data("price"))),
        accessoryPrice = parseFloat(RemoveAllPoint("" == $("#txtAccessoryPrice").val() ? "0" : $("#txtAccessoryPrice").val())),
        firstMoney = parseFloat(RemoveAllPoint($("#txtFirstMoney").val())),
        ownPrice = priceOfCar + accessoryPrice - firstMoney;
    return accessoryPrice > priceOfCar ? (showErrorbyAlert("Hỗ trợ tài chính", "<p>Giá phụ kiện không vượt quá tiền xe!<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), $("#txtFirstMoney").focus(), !1) : "" === $("#txtFirstMoney").val() ? (showErrorbyAlert("Hỗ trợ tài chính", "<p>Vui lòng nhập số tiền trả trước!<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), $("#txtFirstMoney").focus(), !1) : 0 > ownPrice ? (showErrorbyAlert("Hỗ trợ tài chính", "<p>Quý khách đã nhập quá số tổng giá trị xe và phụ kiện, vui lòng nhập lại!<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), $("#txtFirstMoney").focus(), !1) : !0
}

function RemoveAllPoint(str) {
    return str.replace(/\./g, "")
}

function getNumberOfDays(year, month) {
    return moment(year + "-" + month, "YYYY-MM").daysInMonth()
}

function getNextMonth(today) {
    var m = moment(today);
    return m.add(1, "months"), m.toDate()
}

function ClickDownloadFileSupportFinance() {
    $(".btnDownloadFiles").on("click", function() {
        $("#panelEstimate").css("display", "block"), $("#panelStatus_Estimate").text("Đang tạo chi tiết bảng tính...");
        var priceOfCar = parseFloat(RemoveAllPoint($("#ddlMausac").val())),
            accessoryPrice = parseFloat(RemoveAllPoint("" == $("#txtAccessoryPrice").val() || "0" == $("#txtAccessoryPrice").val() ? "0" : $("#txtAccessoryPrice").val())),
            sumOfPrice = priceOfCar + accessoryPrice,
            supportProduct = $("#ddlSupporProduct").val(),
            timeFor = 12 * parseInt($("#ddlTimeFor").val()),
            payMethod = $("#ddlPayMethod").val(),
            firstMoney = parseFloat(RemoveAllPoint($("#txtFirstMoney").val())),
            ownPrice = priceOfCar + accessoryPrice - firstMoney,
            type = 0,
            balloon = parseFloat(RemoveAllPoint("" == $("#txtFinalSeptem").val() ? "0" : $("#txtFinalSeptem").val()));
        switch (supportProduct) {
            case "0":
                type = payMethod;
                break;
            case "1":
                type = 4;
                break;
            case "2":
                type = parseInt(payMethod) + 2
        }
        var t = {
            iTypeFile: type,
            sSoTienMuaXe: sumOfPrice,
            sSoTienVay: ownPrice,
            sThoiGianVay: timeFor,
            Balloon: balloon
        };
        $.ajax({
            type: "POST",
            url: "export-files-estimate",
            data: JSON.stringify(t),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(returnValue) {
                $("#panelStatus_Estimate").text("Bảng tính đã được tạo thành công, đang tải về..."), setTimeout(function() {
                    window.open(returnValue, "_parent"), $("#panelEstimate").css("display", "none")
                }, 1e3)
            }
        })
    })
}
$(document).ready(function() {
    if ($(".hotrotaichinh_tabs .next_btn_0").on("click", function() {
            $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_01").css("display", "block"), $("a[href*='#tab_hotrotaichinh_01']").addClass("active")
        }), $(".various").fancybox({}), $(".selectSupport").on("click", function() {
            if (selectCarFirst()) {
                $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), CalcFirstMoneyBefore();
                var selectCar = $(".checkCarTool:checked"),
                    url = $(selectCar).data("url"),
                    res = url.match(/hilux/g);
                if (null != res) {
                    var length = $("#ddlSupporProduct option[value='2']").length;
                    if (0 == length) {
                        var opt = '<option value="2">Sản phẩm balloon</option>';
                        $("#ddlSupporProduct option[value='2']").remove(), $("#ddlSupporProduct").append(opt), $("#ddlPayMethod option[value='1']").removeAttr("disabled")
                    }
                } else $("#ddlSupporProduct option[value='2']").remove(), $("#ddlPayMethod option[value='1']").attr("disabled", ""), $(".sp_balloon").css("opacity", "0");
                $("#ddlSupporProduct").material_select("destroy"), $("#ddlPayMethod").material_select("destroy"), $("#ddlSupporProduct").material_select(), $("#ddlPayMethod").material_select()
            }
        }), $(".complete").on("click", function() {
            if (selectCarFirst() && checkInput()) {
                $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_03").css("display", "block"), $("a[href*='#tab_hotrotaichinh_03']").addClass("active");
                var selectCar = $(".checkCarTool:checked");
                $(".nameOfCarSelectedTool").text($(selectCar).data("name")), $(".priceOfCarSelectedTool").text($(selectCar).data("price")), $(".imageOfCarSelectedTool").attr("src", $(selectCar).data("image"));
                var priceOfCar = parseFloat(RemoveAllPoint($("#ddlMausac").val())),
                    accessoryPrice = parseFloat(RemoveAllPoint("" == $("#txtAccessoryPrice").val() || "0" == $("#txtAccessoryPrice").val() ? "0" : $("#txtAccessoryPrice").val())),
                    supportProduct = $("#ddlSupporProduct").val(),
                    timeFor = parseInt($("#ddlTimeFor").val()),
                    payMethod = $("#ddlPayMethod").val(),
                    firstMoney = parseFloat(RemoveAllPoint($("#txtFirstMoney").val())),
                    numberOfMonths = 12 * timeFor,
                    ownPrice = priceOfCar + accessoryPrice - firstMoney,
                    ownPriceAverage = Math.floor(ownPrice / numberOfMonths),
                    yearPercent = 7.49;
                switch ($(".spResultAccesoryPrice").text(formatMoney(accessoryPrice + ".000")), $(".spResultFirstPrice").text(formatMoney(firstMoney + ".000")), supportProduct) {
                    case "0":
                        var percentPrice = Math.floor(10 * (priceOfCar + accessoryPrice) / 100);
                        if (percentPrice > firstMoney) showErrorbyAlert("Hỗ trợ tài chính", "<p>Số tiền trả trước tối thiểu là " + formatMoney(percentPrice + ".000") + "<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), $("#txtFirstMoney").focus();
                        else {
                            $(".sp5050").css("display", "none"), $(".spBalloon").css("display", "none"), $(".spTruyenThong").css("display", "block");
                            var today = new Date,
                                nextTwiceToday = (1 == payMethod ? getNextMonth(today) : 0, 1 == payMethod ? getNextMonth(nextTwiceToday) : 0),
                                monthPercent = (getNumberOfDays(today.getFullYear(), today.getMonth() + 1), 1 == payMethod ? yearPercent / 12 * 3 : yearPercent / 12),
                                result1 = Math.floor(ownPrice * (monthPercent / 100)),
                                result = result1 + ownPriceAverage;
                            $(".spPriceTotal").text(formatMoney(result + ".000")), $("#spOwnPrice").text(formatMoney(ownPrice + ".000"))
                        }
                        break;
                    case "1":
                        $(".spTruyenThong").css("display", "none"), $(".spBalloon").css("display", "none"), $(".sp5050").css("display", "block"), yearPercent = 8.99;
                        var perHaftPrice = Math.floor((priceOfCar + accessoryPrice) / 2);
                        if (perHaftPrice > firstMoney) showErrorbyAlert("Hỗ trợ tài chính", "Số tiền trả trước tối thiểu là " + formatMoney(perHaftPrice + ".000"), ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled");
                        else {
                            var ret = Math.floor(ownPrice * yearPercent / 100) + ownPrice;
                            $(".spPriceTotal5050").text(formatMoney(ret + ".000"))
                        }
                        break;
                    case "2":
                        yearPercent = 7.99;
                        var percentPrice = Math.floor(10 * (priceOfCar + accessoryPrice) / 100);
                        if (percentPrice > firstMoney) showErrorbyAlert("Hỗ trợ tài chính", "<p>Số tiền trả trước tối thiểu là " + formatMoney(percentPrice + ".000") + "<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), $("#txtFirstMoney").focus();
                        else {
                            var finalSetem = parseFloat(RemoveAllPoint("" == $("#txtFinalSeptem").val() ? "0" : $("#txtFinalSeptem").val())),
                                finalSeptemMax = Math.floor(.3 * (priceOfCar + accessoryPrice));
                            if (0 >= finalSetem) showErrorbyAlert("Hỗ trợ tài chính", "<p>Vui lòng nhập số tiền trả cuối kỳ<p>", ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), $("#txtFinalSeptem").focus();
                            else {
                                if (finalSetem > finalSeptemMax) return showErrorbyAlert("Hỗ trợ tài chính", "<p>Tiền gốc trả cuối kì tối đa là <p>" + formatMoney(finalSeptemMax + ".000"), ""), $(".hotrotaichinh_tabs .tab").find("a").removeClass("active"), $(".hotrotaichinh_tabs .content-tab").css("display", "none"), $("#tab_hotrotaichinh_02").css("display", "block"), $("a[href*='#tab_hotrotaichinh_02']").addClass("active"), $(".complete").addClass("disabled"), !1;
                                $(".spTruyenThong").css("display", "none"), $(".sp5050").css("display", "none"), $(".spBalloon").css("display", "block");
                                var tien_lai = ownPrice * (yearPercent / 100) / 12;
                                1 == payMethod && (yearPercent = 7.49, tien_lai = ownPrice * (yearPercent / 100) / 12, tien_lai = 3 * tien_lai);
                                var goc_dinhky = Math.floor((ownPrice - finalSetem) / numberOfMonths),
                                    tra_dinhky = tien_lai + goc_dinhky;
                                $(".spPriceTotalBalloon").text(formatMoney(tra_dinhky + ".000")), $("#spOwnPrice").text(formatMoney(ownPrice + ".000"))
                            }
                        }
                }
                $(".btnSendEmail").parent().removeClass("disabled-button");
                var isCan = checkCanGetAPost("ciSupportFinanceCountperDay");
                isCan && postUserClickTools($(selectCar).data("idcar"), "HOTROTAICHINH")
            }
        }), $(".priceInputMask").mask("###.###.###.###.###", {
            reverse: !0
        }), $("#ddlSupporProduct").on("change", function() {
            var val = $(this).val();
            switch (val) {
                case "0":
                    $("#ddlTimeFor").find("option").not("option[value='0']").removeAttr("disabled"), $(".spHinhThucThanhToan,.spThoiHanVay").css("opacity", 1), $(".spHinhThucThanhToan,.spThoiHanVay").css("pointer-events", "all"), $("select").material_select(), $("#spClassPercentFirtMoney").text("(10%)"), $(".sp_balloon").css("opacity", "0");
                    break;
                case "1":
                    $("#ddlTimeFor").find("option").not("option[value='1']").attr("disabled", "disabled"), $("#ddlTimeFor option[value='1']").attr("selected", "selected"), $(".spHinhThucThanhToan,.spThoiHanVay").css("opacity", .6), $(".spHinhThucThanhToan,.spThoiHanVay").css("pointer-events", "none"), $("select").material_select(), $("#spClassPercentFirtMoney").text("(50%)"), $(".sp_balloon").css("opacity", "0");
                    break;
                case "2":
                    $("#ddlTimeFor").find("option").removeAttr("disabled"), $(".spHinhThucThanhToan,.spThoiHanVay").css("opacity", 1), $(".spHinhThucThanhToan,.spThoiHanVay").css("pointer-events", "all"), $("select").material_select(), $(".sp_balloon").css("opacity", "1");
                    break;
                default:
                    $(".sp_balloon").css("opacity", "0")
            }
            CalcFirstMoneyBefore()
        }), $("#frmsendMailHoTroTaiChinh").on("submit", function(event) {
            event.preventDefault()
        }), $(".checkCarTool:checked").length > 0) {
        var obj = $(".checkCarTool:checked");
        $(".spResultTitle").text($(obj).data("name")), $(".spResultPrice").text($(obj).data("price"));
        var idNew = $(obj).data("idcar");
        LoadColor(idNew), $(".selectSupport").click()
    }
    $("#txtAccessoryPrice").on("keyup", function() {
        CalcFirstMoneyBefore()
    }), ClickDownloadFileSupportFinance(), checkCarToolSupportFinance(), $("#ddlMausac").on("change", function() {
        var val = $(this).val();
        $(".spResultPrice").text(FormatNumber(val)), $(".colorOfCarSelectedTool").text($("#ddlMausac option:selected").text());
        var img = $("#ddlMausac option:selected").data("img");
        $(".spResultImage").attr("src", img), CalcFirstMoneyBefore()
    })
});
